{% extends 'warehouse/base.html' %}

{% block title %}
    {% if form.instance.pk %}ÙˆÛŒØ±Ø§ÛŒØ´ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÙˆØ¬{% else %}Ø§ÛŒØ¬Ø§Ø¯ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÛŒØ¯{% endif %} - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†Ø¨Ø§Ø±
{% endblock %}

{% block page_title %}
    {% if form.instance.pk %}ÙˆÛŒØ±Ø§ÛŒØ´ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÙˆØ¬{% else %}Ø§ÛŒØ¬Ø§Ø¯ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÛŒØ¯{% endif %}
{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
    <h3 class="text-lg font-semibold text-gray-800 mb-6">
        <i class="fas fa-info-circle ml-2"></i>
        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ø­ÙˆØ§Ù„Ù‡
    </h3>
    
    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Delivery Order Number -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø´Ù…Ø§Ø±Ù‡ Ø­ÙˆØ§Ù„Ù‡ *</label>
                <input type="text" name="number" value="{{ form.instance.number }}" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                       placeholder="Ù…Ø«Ø§Ù„: DO-2025-001">
            </div>
            
            <!-- Issue Date -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ± *</label>
                <div class="relative">
                    <input type="text" name="issue_date" id="issue_date"
                           value="{% if form.instance.issue_date %}{{ form.instance.issue_date|date:'Y/m/d' }}{% endif %}" 
                           required placeholder="1403/01/01" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 cursor-pointer">
                    <i class="fas fa-calendar-alt absolute left-3 top-3 text-gray-400 pointer-events-none"></i>
                </div>
                <input type="hidden" name="issue_date_gregorian" id="issue_date_gregorian"
                       value="{% if form.instance.issue_date %}{{ form.instance.issue_date|date:'Y-m-d' }}{% endif %}">
            </div>
            
            <!-- Validity Date -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÛŒØ® Ø§Ø¹ØªØ¨Ø§Ø± *</label>
                <div class="relative">
                    <input type="text" name="validity_date" id="validity_date"
                           value="{% if form.instance.validity_date %}{{ form.instance.validity_date|date:'Y/m/d' }}{% endif %}" 
                           required placeholder="1403/12/29" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 cursor-pointer">
                    <i class="fas fa-calendar-alt absolute left-3 top-3 text-gray-400 pointer-events-none"></i>
                </div>
                <input type="hidden" name="validity_date_gregorian" id="validity_date_gregorian"
                       value="{% if form.instance.validity_date %}{{ form.instance.validity_date|date:'Y-m-d' }}{% endif %}">
            </div>
            
            <!-- Warehouse -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù†Ø¨Ø§Ø± *</label>
                <select name="warehouse" required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø±</option>
                    {% for warehouse in warehouses %}
                    <option value="{{ warehouse.id }}" {% if warehouse.id == form.instance.warehouse_id %}selected{% endif %}>
                        {{ warehouse.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Sales Proforma -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´ *</label>
                <select name="sales_proforma" required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</option>
                    {% for proforma in sales_proformas %}
                    <option value="{{ proforma.id }}" {% if proforma.id == form.instance.sales_proforma_id %}selected{% endif %}>
                        {{ proforma.number }} - {{ proforma.customer }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Shipping Company -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø´Ø±Ú©Øª Ø­Ù…Ù„ *</label>
                <select name="shipping_company" required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø±Ú©Øª Ø­Ù…Ù„</option>
                    {% for company in shipping_companies %}
                    <option value="{{ company.id }}" {% if company.id == form.instance.shipping_company_id %}selected{% endif %}>
                        {{ company.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Description -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea name="description" rows="3" 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø­ÙˆØ§Ù„Ù‡...">{{ form.instance.description }}</textarea>
        </div>
        
        <!-- Items Section -->
        <div class="border-t pt-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-boxes ml-2"></i>
                    Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø­ÙˆØ§Ù„Ù‡
                </h3>
                <button type="button" id="addItem" 
                        class="flex items-center px-4 py-2 bg-success-500 text-white rounded-lg hover:bg-success-600 transition-colors">
                    <i class="fas fa-plus ml-2"></i>
                    Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…
                </button>
            </div>
            
            <div id="itemsContainer">
                <!-- Items will be added here dynamically -->
            </div>
            
            <!-- Item Template (Hidden) -->
            <div id="itemTemplate" class="item-row bg-gray-50 p-4 rounded-lg border mb-4" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-sm font-medium text-gray-700">Ø¢ÛŒØªÙ… <span class="item-number"></span></h4>
                    <button type="button" class="remove-item text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ú©Ø§Ù„Ø§ *</label>
                        <select name="items[INDEX][product]" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù„Ø§</option>
                            {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }} ({{ product.unit }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù‚Ø¯Ø§Ø± *</label>
                        <input type="number" name="items[INDEX][quantity]" step="0.01" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               placeholder="0.00">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ ÙˆØ³ÛŒÙ„Ù‡ Ø­Ù…Ù„ *</label>
                        <select name="items[INDEX][vehicle_type]" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ³ÛŒÙ„Ù‡</option>
                            <option value="truck">Ú©Ø§Ù…ÛŒÙˆÙ†</option>
                            <option value="pickup">ÙˆØ§Ù†Øª</option>
                            <option value="van">ÙˆÙ†</option>
                            <option value="container">Ú©Ø§Ù†ØªÛŒÙ†Ø±</option>
                            <option value="other">Ø³Ø§ÛŒØ±</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ú¯ÛŒØ±Ù†Ø¯Ù‡ *</label>
                        <select name="items[INDEX][receiver]" required 
                                class="receiver-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú¯ÛŒØ±Ù†Ø¯Ù‡</option>
                            {% for receiver in receivers %}
                            <option value="{{ receiver.id }}">{{ receiver }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø¢Ø¯Ø±Ø³ Ú¯ÛŒØ±Ù†Ø¯Ù‡</label>
                        <textarea name="items[INDEX][receiver_address]" rows="2" 
                                  class="receiver-address w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                  placeholder="Ø¢Ø¯Ø±Ø³ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ú¯ÛŒØ±Ù†Ø¯Ù‡ ØªÚ©Ù…ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯..." readonly></textarea>
                        <p class="text-xs text-gray-500 mt-1">Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± ØªÚ©Ù…ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="flex justify-between">
            <a href="{% url 'warehouse:delivery_order_list' %}" 
               class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                Ø§Ù†ØµØ±Ø§Ù
            </a>
            <button type="submit" 
                    class="px-6 py-2 bg-success-500 text-white rounded-lg hover:bg-success-600 transition-colors">
                <i class="fas fa-save ml-2"></i>
                Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Form loaded successfully!');
    
    let itemIndex = 0;
    
    // Simple date picker functionality
    function setupDatePicker(inputId, hiddenId) {
        const input = document.getElementById(inputId);
        const hidden = document.getElementById(hiddenId);
        
        if (!input || !hidden) {
            console.error('Date picker elements not found:', inputId, hiddenId);
            return;
        }
        
        // Set default date if empty
        if (!input.value) {
            const today = new Date();
            const shamsiDate = gregorianToShamsi(today);
            input.value = shamsiDate;
            hidden.value = today.toISOString().split('T')[0];
            console.log('Set default date:', shamsiDate);
        }
        
        // Simple click handler - for now just allow manual entry
        input.addEventListener('click', function() {
            this.removeAttribute('readonly');
            this.placeholder = 'Ù…Ø«Ø§Ù„: 1403/01/15';
        });
        
        // Validate and convert date on blur
        input.addEventListener('blur', function() {
            if (this.value) {
                try {
                    const gregorianDate = shamsiToGregorian(this.value);
                    if (gregorianDate) {
                        hidden.value = gregorianDate;
                        console.log('Date converted:', this.value, '->', gregorianDate);
                    }
                } catch (e) {
                    console.error('Date conversion error:', e);
                }
            }
            this.setAttribute('readonly', 'true');
        });
    }
    
    // Simple Shamsi to Gregorian conversion (basic implementation)
    function shamsiToGregorian(shamsiDate) {
        try {
            const parts = shamsiDate.split('/');
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);
            
            // Simple approximation - in production you'd use a proper library
            const gregorianYear = year + 621;
            const gregorianMonth = month;
            const gregorianDay = day;
            
            const date = new Date(gregorianYear, gregorianMonth - 1, gregorianDay);
            return date.toISOString().split('T')[0];
        } catch (e) {
            return null;
        }
    }
    
    // Simple Gregorian to Shamsi conversion (basic implementation)
    function gregorianToShamsi(date) {
        try {
            const year = date.getFullYear() - 621;
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        } catch (e) {
            return '1403/01/01';
        }
    }
    
    // Initialize date pickers
    setupDatePicker('issue_date', 'issue_date_gregorian');
    setupDatePicker('validity_date', 'validity_date_gregorian');
    
    // Receiver data for quick access
    const receiverData = {
        {% for receiver in receivers %}
        {{ receiver.id }}: {
            id: {{ receiver.id }},
            name: '{{ receiver|escapejs }}',
            address: '{{ receiver.address|escapejs }}',
            postal_code: '{{ receiver.postal_code|escapejs }}',
            phone: '{{ receiver.phone|escapejs }}',
            unique_id: '{{ receiver.unique_id|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    console.log('ğŸ“‹ Receiver data loaded:', Object.keys(receiverData).length, 'receivers');
    
    // Add item functionality
    const addItemBtn = document.getElementById('addItem');
    if (!addItemBtn) {
        console.error('âŒ Add item button not found!');
        return;
    }
    
    console.log('âœ… Add item button found, attaching event...');
    addItemBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('ğŸ”˜ Add item button clicked!');
        
        const template = document.getElementById('itemTemplate');
        const container = document.getElementById('itemsContainer');
        
        if (!template || !container) {
            console.error('âŒ Template or container not found!');
            return;
        }
        
        const newItem = template.cloneNode(true);
        newItem.style.display = 'block';
        newItem.id = '';
        
        // Replace INDEX with actual index
        newItem.innerHTML = newItem.innerHTML.replace(/INDEX/g, itemIndex);
        newItem.querySelector('.item-number').textContent = itemIndex + 1;
        
        container.appendChild(newItem);
        console.log('âœ… Item added:', itemIndex + 1);
        
        // Add remove functionality
        const removeBtn = newItem.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('ğŸ—‘ï¸ Removing item');
                newItem.remove();
                updateItemNumbers();
            });
        }
        
        // Add receiver change functionality
        const receiverSelect = newItem.querySelector('.receiver-select');
        const addressField = newItem.querySelector('.receiver-address');
        
        if (receiverSelect && addressField) {
            receiverSelect.addEventListener('change', function() {
                const receiverId = this.value;
                console.log('ğŸ‘¤ Receiver selected:', receiverId);
                
                if (receiverId && receiverData[receiverId]) {
                    const receiver = receiverData[receiverId];
                    console.log('ğŸ“ Using receiver data:', receiver.name);
                    
                    // Populate address field
                    addressField.value = receiver.address || '';
                    addressField.removeAttribute('readonly');
                    addressField.classList.remove('border-red-500');
                    addressField.placeholder = 'Ø¢Ø¯Ø±Ø³ Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´)';
                } else {
                    // Reset field when no receiver is selected
                    addressField.value = '';
                    addressField.setAttribute('readonly', 'true');
                    addressField.placeholder = 'Ø§Ø¨ØªØ¯Ø§ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...';
                }
            });
        }
        
        itemIndex++;
        updateItemNumbers();
    });
    
    // Update item numbers
    function updateItemNumbers() {
        const items = document.querySelectorAll('#itemsContainer .item-row');
        items.forEach((item, index) => {
            const numberSpan = item.querySelector('.item-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
        console.log('ğŸ”¢ Updated item numbers, total items:', items.length);
    }
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('ğŸ“¤ Form submission started');
            
            const items = document.querySelectorAll('#itemsContainer .item-row');
            if (items.length === 0) {
                e.preventDefault();
                alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¢ÛŒØªÙ… Ø¨Ù‡ Ø­ÙˆØ§Ù„Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.');
                console.log('âŒ No items found');
                return false;
            }
            
            // Validate each item
            let isValid = true;
            let invalidCount = 0;
            
            items.forEach((item, index) => {
                const requiredFields = item.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value || !field.value.trim()) {
                        field.classList.add('border-red-500');
                        isValid = false;
                        invalidCount++;
                    } else {
                        field.classList.remove('border-red-500');
                    }
                });
            });
            
            if (!isValid) {
                e.preventDefault();
                alert(`Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯. (${invalidCount} ÙÛŒÙ„Ø¯ Ø®Ø§Ù„ÛŒ)`);
                console.log('âŒ Validation failed, invalid fields:', invalidCount);
                return false;
            }
            
            console.log('âœ… Form validation passed');
        });
    }
    
    // Initialize with first item
    console.log('ğŸš€ Adding first item...');
    setTimeout(function() {
        addItemBtn.click();
    }, 100);
    
    console.log('âœ… Form initialization complete!');
});
</script>
{% endblock %}